function hydrateView() {
    loadSearchFilters(), refreshTableData("");
}

function getSelectedTableFilters() {
    var filters = [];
    for (var index in tableCols) {
        var selectedValues = $("select#" + tableCols[index]).val();
        selectedValues && selectedValues.length > 0 && (filters[index] = selectedValues);
    }
    return filters;
}

function filterData(filters) {
    var filteredRecords = {};
    if (filters) for (var key in _data) {
        var row = _data[key], addToDisplay = !0;
        for (var i in filters) if (filters[i] && filters[i].length > 0) {
            var result = row[tableCols[i]].includes(filters[i]);
            if (result === !1) {
                addToDisplay = !1;
                break;
            }
        }
        addToDisplay && (filteredRecords[key] = row);
    }
    return filteredRecords;
}

function refreshTableData(query) {
    $("tbody tr").remove();
    var filters = getSelectedTableFilters(), recordsToDisplay = filterData(filters);
    createTableBody(recordsToDisplay), jQuery(document).ready(function($) {
        $("tr").click(function() {
            console.log($(this).attr("id")), window.location = "http://www.sciencepolicyatlas.com/organization?org=" + $(this).attr("id");
        });
    });
}

function getRecord(name) {
    var ref = new Firebase("https://atlas-new-format.firebaseio.com/organizations");
    ref.orderByChild("organization_name").startAt(name).endAt(name).once("value", function(snapshot) {
        snapshot.forEach(function(childSnapshot) {
            var key = childSnapshot.key(), data = childSnapshot.val();
            console.log(data);
            var v = "http://www.sciencepolicyatlas.com/organization?org=" + key;
            console.log(v), data && (window.location = "http://www.sciencepolicyatlas.com/organization?org=" + key);
        });
    });
}

function createTableBody(list) {
    console.log(list);
    for (var pos in list) table.find("tbody:last").append(createTableRow(pos, list[pos]));
}

function createTableRow(id, org) {
    var string = "<tr id='" + id + "'>";
    for (var i in tableCols) {
        var column = tableCols[i];
        if (string += "<td class=" + column + ">", "collaboration_links" == column) {
            var collabs = org.collaboration_links ? org.collaboration_links.split(", ") : "";
            for (var i in collabs) {
                var collab = collabs[i], collab_key = collab ? collab.split(" | ") : "";
                for (kv in collab_key) {
                    i > 0 && (string += ", ");
                    var k = collab_key[1], name = collab_key[0];
                    string += '<a href="http://www.sciencepolicyatlas.com/collaboration?collab=' + k + '">' + name + "</a>";
                    break;
                }
            }
        } else string += org[column];
        string += "</td>\n";
    }
    return string;
}

function createTableHeader() {
    for (var string = "<tr>", i = 0; i < tableColumnTitles.length; i++) string += "<th>" + tableColumnTitles[i] + "</th>";
    string += "</tr>", table.find("thead").append(string);
}

function getFirebaseOrganizationData() {
    $.ajax({
        type: "GET",
        dataType: "jsonp",
        url: "https://atlas-new-format.firebaseio.com/organizations/.json",
        success: function(data) {
            _data = data, hydrateView();
        }
    });
}

function loadSearchFilters() {
    for (var i in tableCols) createFilterFor(tableCols[i]);
    $(".chosen-select").chosen().change(function(evt, params) {
        refreshTableData($(".filter").val());
    });
}

function createFilterFor(key) {
    var options = [];
    for (var org in _data) {
        var values = _data[org][key] ? _data[org][key].split(", ") : "";
        if (values.length > 0) for (var n in values) {
            var value = values[n];
            value = value.trim(), value.indexOf("|") > -1 && (value = value.substr(0, value.indexOf("|"))), 
            $.inArray(value, options) === -1 && options.push(value);
        }
    }
    options.sort();
    for (var string = '<select id="' + key + '" class="chosen-select" multiple="' + options.length + '">', i = 0; i < options.length; i++) string += '<option value="' + options[i] + '">' + options[i] + "</option>";
    string += "</select>", $("#options").append(string);
    var l = key.indexOf("_") > -1 ? key.indexOf("_") : key.length, placeHolder = key.substr(0, l);
    placeHolder = placeHolder.charAt(0).toUpperCase() + placeHolder.substr(1), $("#" + key).chosen({
        max_selected_options: 5,
        no_results_text: "Oops, nothing found!",
        width: "90%",
        allow_single_deselect: !0,
        placeholder_text_multiple: placeHolder
    });
}

const table = $("#orgs"), tableCols = [ "organization_name", "state", "collaboration_links" ], tableColumnTitles = [ "Organizations", "State", "Collaborations" ];

_data = {}, getFirebaseOrganizationData(), createTableHeader(), $(".filter").keypress(function(e) {
    13 == e.which && refreshTableData($(this).val());
});