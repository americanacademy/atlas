function hydrateView() {
    console.log("hydrateView"), loadSearchFilters(), refreshTableData("");
}

function getSelectedTableFilters() {
    console.log("getSelectedTableFilters");
    var filters = [];
    for (var index in tableCols) {
        var selectedValues = $("select#" + tableCols[index]).val();
        selectedValues && selectedValues.length > 0 && (filters[index] = selectedValues);
    }
    return filters;
}

function filterData(filters) {
    console.log("filterData");
    var filteredRecords = {};
    if (filters) for (var key in _data) {
        var row = _data[key], addToDisplay = !0;
        for (var i in filters) if (filters[i] && filters[i].length > 0) {
            var result = row[tableCols[i]].includes(filters[i]);
            if (result === !1) {
                addToDisplay = !1;
                break;
            }
        }
        addToDisplay && (filteredRecords[key] = row);
    }
    return filteredRecords;
}

function refreshTableData(query) {
    console.log("refreshTableData"), $("tbody tr").remove();
    var filters = getSelectedTableFilters(), recordsToDisplay = filterData(filters);
    createTableBody(recordsToDisplay), jQuery(document).ready(function($) {
        var tEnd = performance.now();
        console.log("from start to ready took " + (tEnd - tTableStartPerformance) + " milliseconds.");
    });
}

function getRecord(name) {
    console.log("getRecord");
    var ref = new Firebase("https://atlas-new-format.firebaseio.com/organizations");
    ref.orderByChild("organization_name").startAt(name).endAt(name).once("value", function(snapshot) {
        snapshot.forEach(function(childSnapshot) {
            var key = childSnapshot.key(), data = childSnapshot.val();
            console.log(data);
            var v = "http://www.sciencepolicyatlas.com/organization?org=" + key;
            console.log(v), data && (window.location = "http://www.sciencepolicyatlas.com/organization?org=" + key);
        });
    });
}

function createTableBody(list) {
    console.log("createTableBody");
    for (var pos in list) table.find("tbody:last").append(createTableRow(pos, list[pos]));
}

function createTableRow(id, org) {
    console.log("createTableRow");
    var string = "<tr id='" + id + "'>";
    for (var i in tableCols) {
        var column = tableCols[i];
        if (string += "<td class=" + column + ">", "collaboration_links" == column) {
            var collabs = org.collaboration_links ? org.collaboration_links.split(", ") : "";
            for (var i in collabs) {
                var collab = collabs[i], collab_key = collab ? collab.split(" | ") : "";
                for (kv in collab_key) {
                    i > 0 && (string += ", ");
                    var k = collab_key[1], name = collab_key[0];
                    string += '<a target="_top" href="http://www.sciencepolicyatlas.com/collaboration?collab=' + k + '">' + name + "</a>";
                    break;
                }
            }
        } else string += "organization_name" == column ? '<a target="_top" href="http://www.sciencepolicyatlas.com/organization?org=' + id + '">' + org[column] + "</a>" : org[column];
        string += "</td>\n";
    }
    return string;
}

function createTableHeader() {
    console.log("createTableHeader");
    for (var string = "<tr>", i = 0; i < tableColumnTitles.length; i++) string += "<th>" + tableColumnTitles[i] + "</th>";
    string += "</tr>", table.find("thead").append(string);
}

function getsessionStorage() {
    var d = sessionStorage.getItem("data"), data = JSON.parse(d);
    return data;
}

function setsessionStorage(data) {
    if (data) {
        var dataToStore = JSON.stringify(data);
        sessionStorage.setItem("data", dataToStore);
    }
}

function getFirebaseOrganizationData() {
    var tTableStartPerformance = performance.now(), sData = getsessionStorage();
    if (sData) {
        _data = sData, hydrateView();
        var pn = performance.now();
        return void console.log("hydrateView using session data took " + (pn - tTableStartPerformance) + " milliseconds.");
    }
    console.log("getFirebaseOrganizationData"), $.ajax({
        type: "GET",
        dataType: "jsonp",
        url: "https://atlas-new-format.firebaseio.com/organizations/.json",
        success: function(data) {
            _data = data;
            var tEnd = performance.now();
            console.log("getFirebaseOrganizationData took " + (tEnd - tTableStartPerformance) + " milliseconds."), 
            hydrateView();
            var tEnd2 = performance.now();
            console.log("hydrateView took " + (tEnd2 - tEnd) + " milliseconds."), setsessionStorage(_data);
        }
    });
}

function loadSearchFilters() {
    console.log("loadSearchFilters");
    for (var i in tableCols) createFilterFor(tableCols[i]);
    $(".chosen-select").chosen().change(function(evt, params) {
        refreshTableData($(".filter").val());
    });
}

function asc(s1, s2) {
    var s1lower = s1.toLowerCase(), s2lower = s2.toLowerCase();
    return s1lower > s2lower ? 1 : s1lower < s2lower ? -1 : 0;
}

function desc(s1, s2) {
    var s1lower = s1.toLowerCase(), s2lower = s2.toLowerCase();
    return s1lower < s2lower ? 1 : s1lower > s2lower ? -1 : 0;
}

function sortIt(dropdownkey) {
    var id = "#" + dropdownkey, theOptions = $(id + " option");
    theOptions.length > 0 && (theOptions.sort(function(a, b) {
        return a.text > b.text ? 1 : a.text < b.text ? -1 : 0;
    }), $(id).empty(), $(id).chosen({
        no_results_text: "No results matched"
    }));
}

function createFilterFor(key) {
    console.log("createFilterFor");
    var options = [];
    for (var org in _data) {
        var values = _data[org][key] ? _data[org][key].split(", ") : "";
        if (values.length > 0) for (var n in values) {
            var value = values[n];
            value = value.trim(), value.indexOf("|") > -1 && (value = value.substr(0, value.indexOf("|"))), 
            $.inArray(value, options) === -1 && options.push(value);
        }
    }
    "collaboration_links" === key ? options.sort(desc) : options.sort(asc);
    var string = '<select id="' + key + '" class="chosen-select" multiple="' + options.length + '">';
    "organization_category" === key && (string = '<select id="' + key + '" class="chosen-select" multiple="' + options.length + '" data-placeholder="Organization type">');
    for (var i = 0; i < options.length; i++) string += '<option value="' + options[i] + '">' + options[i] + "</option>";
    string += "</select>", $("#options").append(string);
    var l = key.indexOf("_") > -1 ? key.indexOf("_") : key.length, placeHolder = key.substr(0, l);
    placeHolder = placeHolder.charAt(0).toUpperCase() + placeHolder.substr(1), $("#" + key).chosen({
        max_selected_options: 5,
        no_results_text: "Oops, nothing found!",
        width: "90%",
        allow_single_deselect: !0,
        placeholder_text_multiple: placeHolder
    });
}

var tTableStartPerformance = performance.now();

const table = $("#orgs"), tableCols = [ "organization_name", "state", "collaboration_links", "organization_category" ], tableColumnTitles = [ "Organizations", "State", "Participation in Collaboration", "Organization Type" ];

_data = {}, getFirebaseOrganizationData(), createTableHeader(), $(".filter").keypress(function(e) {
    13 == e.which && refreshTableData($(this).val());
});