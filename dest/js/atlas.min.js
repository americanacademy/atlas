function dataLoaded() {
    loadFilters(), tableWithQuery("");
}

function tableWithQuery(query) {
    $("tbody tr").remove(), addHeader();
    var toShow = [], filters = [];
    for (var index in tableCols) {
        var selectedValues = $("select#" + tableCols[index]).val();
        filters[index] = selectedValues;
    }
    for (var key in _data) {
        var row = _data[key], passed = !0;
        for (var i in filters) if (filters[i] && filters[i].length > 0 && $.inArray(row[tableCols[i]], filters[i]) === -1) {
            passed = !1;
            break;
        }
        passed && toShow.push(row);
    }
    loadList(toShow), jQuery(document).ready(function($) {
        $("tr").click(function() {
            window.location = "http://www.sciencepolicyatlas.com/profile?org=" + $(this).attr("id");
        });
    });
}

function loadList(l) {
    for (var i = 0; i < l.length; i++) table.find("tbody:last").append(orgToRow(l[i]));
}

function orgToRow(org) {
    var string = "<tr id='" + org.organizations + "'>";
    for (var i in tableCols) col = tableCols[i], string += "<td class=" + col + ">", 
    string += org[col], string += "</td>\n";
    return string;
}

function addHeader() {
    for (var string = "<tr>", i = 0; i < tableCols.length; i++) string += "<th>" + tableCols[i] + "</th>";
    string += "</tr>", table.find("tbody:first").append(string);
}

function getData() {
    $.ajax({
        type: "GET",
        dataType: "jsonp",
        url: 'https://atlas-9c89c.firebaseio.com/.json?orderBy="organizations"',
        success: function(data) {
            _data = data, dataLoaded();
        }
    });
}

function loadFilters() {
    for (var i in tableCols) createFilterFor(tableCols[i]);
    $(".chosen-select").chosen().change(function(evt, params) {
        tableWithQuery($(".filter").val());
    });
}

function createFilterFor(key) {
    var options = [];
    for (var org in _data) $.inArray(_data[org][key], options) === -1 && options.push(_data[org][key]);
    for (var string = '<select id="' + key + '" class="chosen-select" multiple="' + options.length + '">', i = 0; i < options.length; i++) string += '<option value="' + options[i] + '">' + options[i] + "</option>";
    string += "</select>", $("#options").append(string), $("#" + key).chosen({
        max_selected_options: 5,
        no_results_text: "Oops, nothing found!",
        width: "90%",
        allow_single_deselect: !0,
        placeholder_text_multiple: key
    });
}

const table = $("#orgs"), tableCols = [ "Organization", "State", "Collaborations" ];

_data = {}, $(".filter").keypress(function(e) {
    13 == e.which && tableWithQuery($(this).val());
}), getData();